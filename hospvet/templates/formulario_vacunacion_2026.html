<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>HVX - Campaña de Vacunación</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="form-container">
        <header class="main-header">
            <div class="header-container" style="display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 10px;">
                <img src="{{ url_for('static', filename='img/logo_hve_1.jpeg') }}" alt="Logo Izquierdo" class="logo-img" style="height: 80px; width: auto;">

                <div class="header-text" style="text-align: center; flex-grow: 1;">
                    <h1 style="margin: 0; font-size: 1.8rem; color: #004a99;">Campaña de Vacunación 26 I</h1>
                    <p style="margin: 0; color: #666;">Hospital Veterinario de Especialidades</p>
                </div>

                <img src="{{ url_for('static', filename='img/logo_hve_2.jpeg') }}" alt="Logo Derecho" class="logo-img" style="height: 80px; width: auto;">
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}" style="padding: 15px; margin-bottom: 20px; border-radius: 5px;
                {% if category == 'danger' %} background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
                {% else %} background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; {% endif %}">
                  {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="info-grid-principal">
            <div class="info-card">
                <h4>1. Completa todos los campos solicitados con la información correspondiente.</h4>
                <p> Es importante que los datos sean correctos para confirmar tu cita y brindar una mejor atención.</p>
            </div>

            <div class="info-card">
                <h4>2. Selecciona los servicios de tu interés.</h4>
                <p> Puedes elegir más de una opción según las necesidades de tu animal de compañía.</p>
            </div>

            <div class="info-card">
                <h4>3. Duración de la cita.</h4>
                <p> Cada cita tiene una duración de <strong>1 hora</strong>.</p>
            </div>

            <div class="info-card">
                <h4>4. Consulta gratuita:</h4>
                <ul class="card-list">
                    <li>La consulta constará de una revisión médica <strong>gratuita</strong>.</li>
                    <li>Solo se aplicarán vacunas si el animal se encuentra sano tras la valoración.</li>
                    <li>En el caso de perros, además, un hemograma y un urianálisis.</li>
                </ul>
            </div>

            <div class="info-card dog-highlight">
                <h4>5. Indicaciones EXCLUSIVAMENTE PARA PERROS</h4>
                <p> Además de la consulta gratuita, <strong>si usted lo autoriza</strong>, se tomará una muestra sanguínea para biometría hemática; y se realizará un urianálisis.</p>
                <p> Indicaciones para biometría hemática: <strong>Ayuno de 6 horas</strong></p>
                <p> Indicaciones para urianálisis: <strong>Colecta de orina 1 hora</strong> antes de la cita en frasco limpio y protegido de la luz.</p>
            </div>

            <div class="info-card">
                <h4>6. Indicaciones para el ingreso:</h4>
                <p><strong> Perros:</strong> deben ingresar con <strong>collar y correa.</strong></p>
                <p><strong> Gatos:</strong> deben asistir en <strong>transportadora y premios para su manejo.</strong></p>
            </div>

            <div class="info-card">
                <h4>7. Agenda:</h4>
                <p> Elige el <strong>día y horario</strong> que mejor se adapte a tu disponibilidad.</p>
                <p> Si tienes <strong>más de un animal de compañía,</strong> deberás <strong>registrar a cada una por separado.</strong></p>
            </div>
            <div class="info-card">
                <h4>8. Tabulador de Costos de Recuperación:</h4>
                <div class="contenedor-tablas-dual">
                    <div class="tabla-container">
                        <h5 class="titulo-tabla-perro">Costos Perros</h5>
                        <table class="costos-table">
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th>Normal</th>
                                    <th>Pago anticipado <br> (09-11 Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Vacuna múltiple y Desparasitación Externa</td>
                                    <td>$513.00</td>
                                    <td>$570.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna múltiple y Desparasitación Interna</td>
                                    <td>$360.00</td>
                                    <td>$400.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna Rabia, Desparasitación Interna y Externa</td>
                                    <td>$585.00</td>
                                    <td>$650.00</td>
                                </tr>
                                <tr>
                                    <td>Desparasitación Interna y Externa</td>
                                    <td>$540.00</td>
                                    <td>$600.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna múltiple y Rabia</td>
                                    <td>$360.00</td>
                                    <td>$400.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna cuádruple, Vacuna múltiple y Rabia</td>
                                    <td>$675.00</td>
                                    <td>$750.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna cuádruple, Vacuna múltiple y Rabia, Desp. Int. y Ext.</td>
                                    <td>$855.00</td>
                                    <td>$950.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna Bordetella</td>
                                    <td>$270.00</td>
                                    <td>$300.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna Rabia</td>
                                    <td>$225.00</td>
                                    <td>$250.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna séxtuple</td>
                                    <td>$405.00</td>
                                    <td>$450.00</td>
                                </tr>
                                <tr>
                                    <td>Vacuna cuádruple</td>
                                    <td>$360.00</td>
                                    <td>$400.00</td>
                                </tr>
                                <tr class="table-secondary">
                                    <td colspan="3"><strong>Desparasitaciones según peso (Perros)</strong></td>
                                </tr>
                                <tr>
                                    <td>Interna (Menor a 10Kg)</td>
                                    <td>$216.00</td>
                                    <td>$240.00</td>
                                </tr>
                                <tr>
                                    <td>Interna (10Kg hasta 20Kg)</td>
                                    <td>$252.00</td>
                                    <td>$280.00</td>
                                </tr>
                                <tr>
                                    <td>Interna (Mayor a 20Kg)</td>
                                    <td>$270.00</td>
                                    <td>$300.00</td>
                                </tr>
                                <tr>
                                    <td>Externa (Menor a 10Kg)</td>
                                    <td>$180.00</td>
                                    <td>$200.00</td>
                                </tr>
                                <tr>
                                    <td>Externa (10Kg hasta 20Kg)</td>
                                    <td>$225.00</td>
                                    <td>$250.00</td>
                                </tr>
                                <tr>
                                    <td>Externa (Mayor a 20Kg)</td>
                                    <td>$270.00</td>
                                    <td>$300.00</td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                    <div class="tabla-container">
                        <h5 class="titulo-tabla-gato">Costos Gatos</h5>
                        <table class="costos-table">
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th>Normal</th>
                                    <th>Pago anticipado <br> (09-11 Feb)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>V. Cuádruple + Desp. Comp</td><td>$560</td><td>$504</td></tr>
                                <tr><td>Prueba VIF/Leucemia</td><td>$890</td><td>$801</td></tr>
                                <tr><td>V. Rabia + Desp. Comp</td><td>$450</td><td>$405</td></tr>
                                <tr><td>V. Cuádruple Felina</td><td>$350</td><td>$315</td></tr>
                                <tr><td>Desp. Int. y Ext.</td><td>$400</td><td>$360</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="alerta-urgencias">
                <strong><i class="fas fa-exclamation-triangle"></i> IMPORTANTE:</strong>
                <p>• No se atenderán casos de urgencia.</p>
                <p>• Si tu animal de compañía presenta signos de enfermedad, no asistas y consulta con un
                médico veterinario de inmediato.</p>
                <p>• Las fechas y horarios estarán sujetos a disponibilidad</p>
            </div>
        </div>


        <form action="{{ url_for('campvacuna.campvacini') }}" method="POST" enctype="multipart/form-data">
            <!--dejar esto {{ form.hidden_tag() }} una vez que no este en render-->
            {{ form.hidden_tag() }} {% if form.errors %}
                <div style="color: red; border: 1px solid red; padding: 10px;">
                    <ul>
                    {% for field, errors in form.errors.items() %}
                        <li>{{ field }}: {{ errors|join(', ') }}</li>
                    {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <div class="form-grid">

                <div class="full-column">
                    {{ form.email.label }}
                    {{ form.email(placeholder="ejemplo@correo.com") }}
                </div>

                <div class="contenedor-nombres-fila full-column" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">

                    <div class="grupo-input">
                        {{ form.nombre.label }}
                        {{ form.nombre(placeholder="Nombre") }}
                    </div>

                    <div class="grupo-input">
                        {{ form.apellido1.label }}
                        {{ form.apellido1(placeholder="Apellido 1") }}
                    </div>

                    <div class="grupo-input">
                        {{ form.apellido2.label }}
                        {{ form.apellido2(placeholder="Apellido 2") }}
                    </div>

                </div>

                <div class="grupo-input">
                    {{ form.mascota.label }}
                    {{ form.mascota(placeholder="Nombre de la mascota") }}
                </div>

                <div class="grupo-input">
                    {{ form.edad.label }}
                    {{ form.edad(placeholder="Edad") }}
                </div>

                <div class="grupo-input">
                    {{ form.telefono.label }}
                    {{ form.telefono(placeholder="10 dígitos", type="tel") }}
                </div>
                <!--script1-->
                <!--<script>
                    // 1. Mostrar/Ocultar secciones según la especie
                    function toggleEspecie() {
                        const selector = document.getElementById("especie");
                        const especie = selector.value;

                        const divGatos = document.getElementById("div_gatos");
                        const divPerros = document.getElementById("div_perros");

                        if (divGatos) divGatos.classList.toggle("hidden", especie !== "Gato");
                        if (divPerros) divPerros.classList.toggle("hidden", especie !== "Perro");

                        // Cada vez que cambia la especie, filtramos los horarios
                        filtrarHorarios();
                    }

                    // 2. Filtrar horarios según Especie, Día y Cupos
                    function filtrarHorarios() {
                        const especie = document.getElementById("especie").value;
                        const dia = document.getElementById("dia_semana").value;
                        const horarioSelect = document.getElementById("bloque_horario");

                        // Traemos la lista de Flask (asegúrate que routes.py la envíe)
                        const agotados = {{ horarios_llenos | default([]) | tojson | safe }};

                        if (!horarioSelect) return;

                        // Backup de las opciones originales para no perderlas al vaciar el select
                        if (!window.opcionesBase) {
                            window.opcionesBase = Array.from(horarioSelect.options);
                        }

                        const valorPrevio = horarioSelect.value;
                        horarioSelect.innerHTML = '';

                        window.opcionesBase.forEach(option => {
                            if (option.value === "") {
                                horarioSelect.appendChild(option.cloneNode(true));
                                return;
                            }

                            const hora = option.value;
                            let esValido = false;

                            // LÓGICA DE AGENDA: Filtramos visualmente para que no se mezclen
                            if (especie === "Perro") {
                                // Perros ven: 10, 11 y tarde (15-17)
                                if (hora.startsWith("10") || hora.startsWith("11") || parseInt(hora) >= 15) {
                                    esValido = true;
                                }
                            } else if (especie === "Gato") {
                                // Gatos ven: 12, 13 y tarde (15-17)
                                if (hora.startsWith("12") || hora.startsWith("13") || parseInt(hora) >= 15) {
                                    esValido = true;
                                }
                            }

                            if (esValido) {
                                const nuevaOpcion = option.cloneNode(true);
                                const llave = `${especie}|${dia}|${hora}`;

                                if (agotados.includes(llave)) {
                                    nuevaOpcion.disabled = true;
                                    nuevaOpcion.text += " (CUPO LLENO)";
                                    nuevaOpcion.style.color = "red";
                                }
                                horarioSelect.appendChild(nuevaOpcion);
                            }
                        });

                        horarioSelect.value = valorPrevio;
                    }

                    // 3. Validación de archivo y confirmación
                    function validarRegistro() {
                        const fileInput = document.getElementById('comprobante_pago');
                        const submitBtn = document.querySelector('.btn-submit');
                        const checkConfirm = document.getElementById('confirmacion');

                        const tieneArchivo = fileInput && fileInput.files.length > 0;
                        const estaConfirmado = checkConfirm ? checkConfirm.checked : true;

                        if (submitBtn) {
                            if (tieneArchivo && estaConfirmado) {
                                submitBtn.disabled = false;
                                submitBtn.style.opacity = "1";
                            } else {
                                submitBtn.disabled = true;
                                submitBtn.style.opacity = "0.5";
                            }
                        }
                    }

                    // Inicialización al cargar la página
                    document.addEventListener('DOMContentLoaded', function() {
                        toggleEspecie();
                        validarRegistro();

                        // Escuchar cambios en el selector de día
                        document.getElementById('dia_semana').addEventListener('change', filtrarHorarios);

                        // Escuchar cambios en el checkbox de confirmación
                        const checkConfirm = document.getElementById('confirmacion');
                        if (checkConfirm) checkConfirm.addEventListener('change', validarRegistro);

                        // Lógica para el input de archivo
                        const fileInput = document.getElementById('comprobante_pago');
                        if (fileInput) {
                            fileInput.addEventListener('change', function() {
                                const btnQuitar = document.getElementById('btn-quitar-archivo');
                                const infoNombre = document.getElementById('nombre-archivo');
                                if (this.files.length > 0) {
                                    infoNombre.textContent = "Seleccionado: " + this.files[0].name;
                                    btnQuitar.classList.remove('hidden');
                                }
                                validarRegistro();
                            });
                        }

                        // Botón quitar archivo
                        document.getElementById('btn-quitar-archivo').addEventListener('click', function() {
                            const fileInput = document.getElementById('comprobante_pago');
                            fileInput.value = "";
                            document.getElementById('nombre-archivo').textContent = "";
                            this.classList.add('hidden');
                            validarRegistro();
                        });
                    });

                 </script>
                -->
                 <div class="full-column">
                    {{ form.especie.label }}
                    {{ form.especie(onchange="toggleEspecie()", id="especie") }}
                </div>

                <div id="div_gatos" class="hidden full-column">
                    <h3 style="color: #2c3e50; margin-top: 20px;">Servicios para Gatos</h3>

                    <div class="checkbox-list-container">
                        {{ form.servicios_gato() }}
                    </div>

                </div>

                <div id="div_perros" class="hidden full-column">
                    <h3 style="color: #2c3e50; margin-top: 20px; text-align: center;">Servicios para Perros</h3>

                    <div class="checkbox-list-container">
                        {{ form.servicios_perro() }}
                    </div>

                    <div class="seccion-pesos-container" style="width: 100%; margin: 30px 0; display: flex; justify-content: center;">
                        <div class="fila-pesos" style="display: flex; gap: 30px; width: 100%; max-width: 1000px;">

                            <div class="grupo-input" style="flex: 1; min-width: 0;">
                                <label style="text-align: center; display: block; margin-bottom: 15px; width: 100%;">
                                    <strong>{{ form.rango_peso_perro_interno.label }}</strong>
                                </label>
                                <div class="radio-group-vertical">
                                    {% for subfield in form.rango_peso_perro_interno %}
                                        <label class="radio-item">
                                            {{ subfield }}
                                            <span>{{ subfield.label.text }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="grupo-input" style="flex: 1; min-width: 0;">
                                <label style="text-align: center; display: block; margin-bottom: 15px; width: 100%;">
                                    <strong>{{ form.rango_peso_perro_externo.label }}</strong>
                                </label>
                                <div class="radio-group-vertical">
                                    {% for subfield in form.rango_peso_perro_externo %}
                                        <label class="radio-item">
                                            {{ subfield }}
                                            <span>{{ subfield.label.text }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="contenedor-nombres-fila full-column" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <h3 style="color: #2c3e50; margin-top: 20px;">Selecciona el día y hora de la cita</h3>
                    <div class="grupo-input">
                        {{ form.dia_semana.label }}
                        {{ form.dia_semana() }}
                    </div>

                    <div class="grupo-input">
                        {{ form.bloque_horario.label }}
                        {{ form.bloque_horario() }}
                    </div>
                </div>


                <div class="full-column">
                    <div class="checkbox-group" style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
                        {{ form.confirmacion() }}
                        <label style="margin: 0;">{{ form.confirmacion.label.text }}</label>
                    </div>
                </div>

                <div class="full-column" style="margin-top: 20px;">
                    <label><strong>9. Subir Comprobante de Pago (Obligatorio):</strong></label>
                    <div class="file-upload-wrapper">
                        <input type="file" id="comprobante_pago" name="comprobante_pago"
                               accept=".pdf, .jpg, .jpeg, .png" required>

                        <button type="button" id="btn-quitar-archivo" class="hidden"
                                style="margin-top: 10px; background: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                            ✕ Quitar archivo seleccionado
                        </button>

                        <p id="nombre-archivo" style="font-size: 0.9rem; color: #2c3e50; margin-top: 5px;"></p>
                    </div>
                </div>

                 {{ form.submit(class="btn-submit") }}
            </div>
        </form>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const especieSelector = document.getElementById("especie");
            const diaSelector = document.getElementById("dia_semana");
            const horarioSelect = document.getElementById("bloque_horario");
            const fileInput = document.getElementById('comprobante_pago');
            const checkConfirm = document.getElementById('confirmacion');
            const submitBtn = document.querySelector('.btn-submit');
            const btnQuitar = document.getElementById('btn-quitar-archivo');
            const infoNombre = document.getElementById('nombre-archivo');


            if (!window.opcionesBase && horarioSelect) {
                window.opcionesBase = Array.from(horarioSelect.options);
            }

            function actualizarInterfaz() {
                const especie = especieSelector.value;


                const divGatos = document.getElementById("div_gatos");
                const divPerros = document.getElementById("div_perros");
                if (divGatos) divGatos.classList.toggle("hidden", especie !== "Gato");
                if (divPerros) divPerros.classList.toggle("hidden", especie !== "Perro");


                filtrarHorarios();
            }

            function filtrarHorarios() {
                if (!horarioSelect || !window.opcionesBase) return;

                const especie = especieSelector.value;
                const dia_actual = diaSelector.value;
                const agotados = {{ horarios_llenos | default([]) | tojson | safe }};
                const valorPrevio = horarioSelect.value;


                horarioSelect.innerHTML = '';

                window.opcionesBase.forEach(option => {

                    if (option.value === "") {
                        horarioSelect.appendChild(option.cloneNode(true));
                        return;
                    }


                    const nuevaOpcion = option.cloneNode(true);
                    const hora = option.value;
                    const llave = `${especie}|${dia_actual}|${hora}`;

                    if (agotados.includes(llave)) {
                        nuevaOpcion.disabled = true;
                        nuevaOpcion.text += " (CUPO LLENO)";
                        nuevaOpcion.style.color = "red";
                    }

                    horarioSelect.appendChild(nuevaOpcion);
                });

                horarioSelect.value = valorPrevio;
            }

            function validarFormulario() {
                const tieneArchivo = fileInput && fileInput.files.length > 0;
                const estaConfirmado = checkConfirm ? checkConfirm.checked : true;

                if (submitBtn) {
                    const listo = tieneArchivo && estaConfirmado;
                    submitBtn.disabled = !listo;
                    submitBtn.style.opacity = listo ? "1" : "0.5";
                }
            }

            // Eventos
            especieSelector.addEventListener('change', actualizarInterfaz);
            diaSelector.addEventListener('change', filtrarHorarios);
            if (checkConfirm) checkConfirm.addEventListener('change', validarFormulario);

            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        infoNombre.textContent = "Seleccionado: " + this.files[0].name;
                        btnQuitar.classList.remove('hidden');
                    }
                    validarFormulario();
                });
            }

            if (btnQuitar) {
                btnQuitar.addEventListener('click', function() {
                    fileInput.value = "";
                    infoNombre.textContent = "";
                    this.classList.add('hidden');
                    validarFormulario();
                });
            }

            // Inicialización
            actualizarInterfaz();
            validarFormulario();
        });
        </script>
    <footer>
        <p style= "color: #ccc;">
        &copy; 2026 Diseño de sistemas UAMX .Todos los derechos reservados.
        </p>
    </footer>
</body>
</html>
